<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRY LANCHES ‚Äî POS (Revisado)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
<style>
:root{
  --bg:#f6f8fb; --card:#fff; --muted:#6b7280; --text:#0f172a;
  --primary:#6d28d9; --primary2:#8b5cf6; --danger:#ef4444; --success:#10b981;
  --radius:12px; --shadow:0 10px 30px rgba(15,23,42,0.06);
}

/* Global + prevent horizontal scroll */
*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#eef2ff 0%, #f6fbff 100%); color:var(--text); overflow-x:hidden;}
header{position:sticky;top:0;background:rgba(255,255,255,0.95);backdrop-filter:blur(6px); padding:12px 16px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(15,23,42,0.04); z-index:40}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:44px;height:44px;border-radius:10px;display:grid;place-items:center;color:#fff;background:linear-gradient(135deg,var(--primary),var(--primary2));font-weight:800}
.container{max-width:1200px;margin:18px auto;padding:12px;display:grid;grid-template-columns:300px 1fr;gap:16px; width: calc(100% - 24px);}
.card{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
.nav-btn{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:10px;border:none;background:transparent;color:var(--muted);cursor:pointer;font-weight:700}
.nav-btn.active{background:linear-gradient(90deg,rgba(109,40,217,0.08),rgba(139,92,246,0.04));color:var(--primary)}
.search-box{position:relative}
.search-box input{width:100%;padding:10px 12px 10px 36px;border-radius:10px;border:1px solid rgba(15,23,42,0.06)}
.search-box .material-icons-round{position:absolute;left:8px;top:7px;color:var(--muted)}

.content-area{display:flex;flex-direction:column;gap:14px}
.panel{background:linear-gradient(180deg,#fff,#fbfdff);padding:12px;border-radius:10px;border:1px solid rgba(15,23,42,0.03)}
.sale-grid{display:grid;grid-template-columns:1fr 320px;gap:12px}
.products-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
.product-card{padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.04);background:#fff}
.cart{display:flex;flex-direction:column;gap:10px}
.cart-list{display:flex;flex-direction:column;gap:8px;max-height:320px;overflow:auto}
.cart-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid rgba(15,23,42,0.03)}
.qty-controls{display:flex;gap:6px;align-items:center}
.small{font-size:13px;color:var(--muted)}
.totals{text-align:right}
.total-amount{font-weight:800;color:var(--primary);font-size:20px}

/* small summarized alert in sidebar */
.lowstock-summary{padding:8px;border-radius:8px;background:#fff8e6;border:1px solid rgba(250,180,30,0.12);color:#a16207;font-weight:700;display:flex;align-items:center;justify-content:space-between;gap:8px}
.lowstock-summary button{background:transparent;border:0;color:var(--primary);cursor:pointer;font-weight:700}

/* alertbox for sales area */
.alert-box{padding:10px;border-radius:8px;background:linear-gradient(90deg,#fff4f4,#fff);border:1px solid rgba(239,68,68,0.12);color:var(--danger);font-weight:700}

/* modal */
.modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);z-index:90}
.modal-backdrop.active{display:flex}
.modal{background:var(--card);padding:16px;border-radius:12px;width:100%;max-width:520px;box-shadow:0 30px 80px rgba(2,6,23,0.25)}
.btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
.btn.primary{background:linear-gradient(90deg,var(--primary),var(--primary2));color:white}
.btn.ghost{background:transparent;border:1px solid rgba(15,23,42,0.06)}
.btn.danger{background:var(--danger);color:white}

/* responsive: remove lateral scroll & adapt sizes */
@media(max-width:1000px){
  .container{grid-template-columns:1fr; padding:10px; gap:12px; width: 100%;}
  .sale-grid{grid-template-columns:1fr; }
  aside.card{order:2}
  .content-area{order:1}
  .logo{width:38px;height:38px}
  header{padding:10px}
}

/* ensure select and inputs never overflow */
select, input, button { max-width:100%; box-sizing:border-box; }

</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">DL</div>
    <div>
      <div id="store-name-display" style="font-weight:800">DRY LANCHES</div>
      <div class="small">PDV Offline ‚Äî Revisado</div>
    </div>
  </div>

  <div style="display:flex;gap:8px;align-items:center">
    <button class="btn ghost" id="btn-header-add"><span class="material-icons-round">add</span></button>
    <button class="btn ghost" id="btn-open-restore"><span class="material-icons-round">restore</span></button>
    <input type="file" id="import-file" accept=".json" style="display:none">
  </div>
</header>

<main class="container">
  <!-- SIDEBAR -->
  <aside class="card" style="display:flex;flex-direction:column;gap:12px">
    <div class="search-box">
      <span class="material-icons-round">search</span>
      <input id="search-products" placeholder="Buscar (nome ou c√≥digo)..." />
    </div>

    <nav style="display:flex;flex-direction:column;gap:6px">
      <button class="nav-btn active" data-tab="sales"> <span class="material-icons-round">point_of_sale</span> Vender</button>
      <button class="nav-btn" data-tab="products"> <span class="material-icons-round">inventory_2</span> Estoque</button>
      <button class="nav-btn" data-tab="history"> <span class="material-icons-round">history</span> Hist√≥rico</button>
      <button class="nav-btn" data-tab="settings"> <span class="material-icons-round">settings</span> Ajustes</button>
    </nav>

    <!-- Summarized low-stock indicator ONLY (no product list here) -->
    <div id="low-stock-summary" style="margin-top:8px"></div>
  </aside>

  <!-- CONTENT -->
  <section class="content-area">
    <!-- SALES -->
    <div id="tab-sales" class="panel">
      <h2 style="margin:0 0 10px 0">Nova Venda          <button class="btn primary" id="btn-add-to-cart"><span class="material-icons-round">add_shopping_cart</span></button>       <input id="qty" type="number" min="1" value="1" style="width:90px;padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.06)"> </h2>

      <!-- short alerts -->
      <div id="sales-alert-area"></div>

      <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
        <select id="sel-product" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.06)"></select>

      </div>

      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:260px">
          <h3 style="margin:10px 0 6px 0">Itens selecionados</h3>
          <div class="cart">
            <div class="cart-list" id="cart-list"></div>
          </div>
        </div>

        <aside style="width:320px;min-width:220px">
          <div class="panel">
            <div class="totals">
              <div class="small">TOTAL</div>
              <div class="total-amount" id="sale-total">R$ 0,00</div>
            </div>

            <div style="margin-top:10px">
              <label class="small">Valor Pago</label>
              <input id="valor-pago" type="number" step="0.01" placeholder="0.00" style="padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)">
            </div>

            <div style="display:flex;gap:8px;margin-top:10px">
              <button class="btn primary" id="btn-register-sale" style="flex:1">Finalizar Venda</button>
              <button class="btn" id="btn-calc-change"><span class="material-icons-round">calculate</span></button>
            </div>

            <div style="margin-top:12px">
              <div class="small">Troco</div>
              <div id="troco" style="font-weight:800">R$ 0,00</div>
            </div>
          </div>

          <div style="margin-top:12px" class="panel">
            <div style="display:flex;gap:8px">
              <button class="btn ghost" id="btn-manual-code"><span class="material-icons-round">keyboard</span> Digitar c√≥digo</button>
              <button class="btn ghost" id="btn-toggle-camera"><span class="material-icons-round">qr_code_scanner</span> Ler</button>
            </div>
          </div>
        </aside>
      </div>
    </div>

    <!-- PRODUCTS - manage products -->
    <div id="tab-products" class="panel" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0">Cat√°logo</h2>
        <div>
          <button class="btn primary" id="btn-add-prod-tab"><span class="material-icons-round">add</span> Novo</button>
        </div>
      </div>
      <div style="margin-top:12px; display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:12px" id="products-grid-full"></div>
    </div>

    <!-- HISTORY -->
    <div id="tab-history" class="panel" style="display:none">
      <h2 style="margin:0 0 8px 0">Hist√≥rico</h2>
      <div id="sales-history" style="display:flex;flex-direction:column;gap:8px"></div>
    </div>

    <!-- SETTINGS -->
    <div id="tab-settings" class="panel" style="display:none">
      <h2 style="margin:0 0 8px 0">Ajustes</h2>

      <div style="margin-bottom:8px">
        <div style="font-weight:800">‚ö† Estoque baixo ‚Äî reposi√ß√£o necess√°ria</div>
        <div id="low-stock-full" style="margin-top:8px"></div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn ghost" id="btn-backup-data"><span class="material-icons-round">download</span> Exportar</button>
        <button class="btn ghost" id="btn-restore-data"><span class="material-icons-round">upload</span> Restaurar</button>
        <button class="btn danger" id="btn-reset-data" style="margin-left:auto"><span class="material-icons-round">delete_forever</span> LIMPAR TUDO</button>
      </div>
      <input type="file" id="import-file-settings" accept=".json" style="display:none">
    </div>

  </section>
</main>

<!-- camera modal area -->
<div id="camera-area" class="modal-backdrop" style="display:none;align-items:center;justify-content:center">
  <div class="modal" style="width:90%;max-width:640px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0">Leitor de C√≥digo</h3>
      <button class="btn ghost" id="btn-stop-scan"><span class="material-icons-round">close</span></button>
    </div>
    <div style="background:#000;border-radius:8px;overflow:hidden">
      <video id="video" autoplay playsinline style="width:100%;height:auto;max-height:420px;display:block"></video>
    </div>
  </div>
</div>

<!-- modal add/edit product -->
<div id="modal-backdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 id="modal-title">Produto</h3>
      <button class="btn ghost" id="btn-close-modal"><span class="material-icons-round">close</span></button>
    </div>
    <div style="display:grid;gap:8px;margin-top:8px">
      <label>Nome</label><input id="p-name">
      <label>C√≥digo (opcional)</label><input id="p-barcode">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><label>Pre√ßo</label><input id="p-price" type="number" step="0.01"></div>
        <div><label>Estoque</label><input id="p-stock" type="number"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
        <button class="btn ghost" id="btn-cancel-modal">Cancelar</button>
        <button class="btn primary" id="btn-save-product">Salvar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
(() => {
  'use strict';

  // Keys
  const STORE_PRODUCTS = 'dry_products_v4';
  const STORE_SALES = 'dry_sales_v4';
  const STORE_CFG = 'dry_cfg_v4';
  const ADMIN_PASSWORD = 'admin';

  // Helpers
  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));
  const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2);

  // State
  let products = [];
  let sales = [];
  let config = { store_name: 'DRY LANCHES', currency: 'R$' };
  let cart = [];

  // Camera
  let video=null, stream=null, scanning=false, canvas=null;

  // Load/save
  function loadData(){
    try {
      products = JSON.parse(localStorage.getItem(STORE_PRODUCTS) || '[]');
      sales = JSON.parse(localStorage.getItem(STORE_SALES) || '[]');
      const cfg = localStorage.getItem(STORE_CFG);
      if(cfg) config = JSON.parse(cfg);
    } catch(e){ console.error(e); products=[]; sales=[]; }
    if(qs('#store-name-display')) qs('#store-name-display').textContent = config.store_name || 'DRY LANCHES';
  }
  function saveData(){
    localStorage.setItem(STORE_PRODUCTS, JSON.stringify(products));
    localStorage.setItem(STORE_SALES, JSON.stringify(sales));
    localStorage.setItem(STORE_CFG, JSON.stringify(config));
  }

  // Seed sample if empty
  function seedIfEmpty(){
    if(products.length === 0){
      products = [
        { id: uid(), name: 'X-Salada', barcode: '1001', price: 12.00, stock: 20 },
        { id: uid(), name: 'X-Bacon', barcode: '1002', price: 15.00, stock: 12 },
        { id: uid(), name: 'Coca 350ml', barcode: '2001', price: 6.50, stock: 4 }, // low stock sample
        { id: uid(), name: '√Ågua 500ml', barcode: '2002', price: 4.00, stock: 25 }
      ];
      saveData();
    }
  }

  // Format money
  function formatMoney(v){ const n=Number(v||0); return (config.currency ? config.currency + ' ' : '') + n.toFixed(2).replace('.', ','); }
  function parseMoneyText(t){ if(!t) return 0; const cleaned = String(t).replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',','.'); const n=parseFloat(cleaned); return isNaN(n)?0:n; }

  /* ====== RENDER: product select now FILTERS by search input ====== */
  function renderProductSelect(){
    const sel = qs('#sel-product');
    if(!sel) return;
    const search = (qs('#search-products') && qs('#search-products').value) ? qs('#search-products').value.toLowerCase() : '';
    sel.innerHTML = '<option value="">-- Selecione --</option>';
    products
      .filter(p => {
        if(!search) return true;
        const name = p.name ? p.name.toLowerCase() : '';
        const bc = p.barcode ? String(p.barcode).toLowerCase() : '';
        return name.includes(search) || bc.includes(search);
      })
      .forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.name} ‚Äî ${formatMoney(p.price)} ${p.barcode ? '‚Ä¢ #' + p.barcode : ''}`;
        sel.appendChild(opt);
      });
  }

  /* ====== low-stock summary (sidebar) - only a short message + button to open Ajustes ====== */
  function renderLowStockSummary(){
    const container = qs('#low-stock-summary');
    if(!container) return;
    const low = products.filter(p => Number(p.stock) >= 0 && Number(p.stock) < 5);
    if(low.length === 0){
      container.innerHTML = '';
      return;
    }
    container.innerHTML = `<div class="lowstock-summary">
      <div>‚ö† Estoque baixo ‚Äî reposi√ß√£o necess√°ria (${low.length})</div>
      <div><button id="btn-open-settings-from-low">Ver Ajustes</button></div>
    </div>`;
    // add handler to open settings
    const btn = qs('#btn-open-settings-from-low');
    if(btn) btn.addEventListener('click', () => {
      // switch tab to settings
      qsa('.nav-btn').forEach(b => b.classList.remove('active'));
      const settingsBtn = qsa('.nav-btn').find(n => n.dataset.tab === 'settings');
      if(settingsBtn) settingsBtn.classList.add('active');
      ['sales','products','history','settings'].forEach(t => qs('#tab-'+t).style.display = (t==='settings' ? 'block' : 'none'));
      // scroll to top for clarity
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }

  /* ====== low-stock full list (settings) ====== */
  function renderLowStockFull(){
    const full = qs('#low-stock-full');
    if(!full) return;
    full.innerHTML = '';
    const low = products.filter(p => Number(p.stock) >= 0 && Number(p.stock) < 5);
    if(low.length === 0){
      full.innerHTML = '<div class="small">Nenhum produto em n√≠vel cr√≠tico.</div>';
      return;
    }
    low.forEach(p => {
      const d = document.createElement('div'); d.className = 'small'; d.textContent = `${p.name} ‚Äî ${p.stock} un`;
      full.appendChild(d);
    });
  }

  function renderProductsGridFull(){
    const grid = qs('#products-grid-full');
    if(!grid) return;
    const search = (qs('#search-products') && qs('#search-products').value) ? qs('#search-products').value.toLowerCase() : '';
    grid.innerHTML = '';
    products
      .filter(p => {
        if(!search) return true;
        const name = p.name ? p.name.toLowerCase() : '';
        const bc = p.barcode ? String(p.barcode).toLowerCase() : '';
        return name.includes(search) || bc.includes(search);
      })
      .forEach(p => {
      const c = document.createElement('div'); c.className = 'product-card';
      c.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>${p.name}</strong><div class="small">${p.barcode?('#'+p.barcode):''}</div></div>
        <div style="text-align:right"><div class="small">${p.stock} un</div><div style="font-weight:800;color:var(--primary)">${formatMoney(p.price)}</div></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn ghost" data-edit="${p.id}"><span class="material-icons-round">edit</span></button>
        <button class="btn" data-add="${p.id}"><span class="material-icons-round">add_shopping_cart</span></button>
      </div>`;
      grid.appendChild(c);
    });
  }

  function renderCart(){
    const list = qs('#cart-list'); list.innerHTML = '';
    let total = 0;
    cart.forEach(item => {
      total += Number(item.price) * Number(item.qty);
      const node = document.createElement('div'); node.className = 'cart-item';
      node.innerHTML = `<div style="flex:1">
        <div style="font-weight:700">${item.name}</div>
        <div class="small">${formatMoney(item.price)} ‚Ä¢ ${item.qty}x</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
        <div class="qty-controls">
          <button class="btn ghost" data-decrease="${item.id}">-</button>
          <div style="min-width:28px;text-align:center">${item.qty}</div>
          <button class="btn ghost" data-increase="${item.id}">+</button>
        </div>
        <button class="btn danger" data-remove="${item.id}">Excluir</button>
      </div>`;
      list.appendChild(node);
    });

    qs('#sale-total').textContent = formatMoney(total);

    // attach buttons - re-query each time
    qsa('[data-increase]').forEach(btn => btn.onclick = () => changeCartQty(btn.getAttribute('data-increase'), +1));
    qsa('[data-decrease]').forEach(btn => btn.onclick = () => changeCartQty(btn.getAttribute('data-decrease'), -1));
    qsa('[data-remove]').forEach(btn => btn.onclick = () => removeCartItem(btn.getAttribute('data-remove')));
  }

  function renderHistory(){
    const el = qs('#sales-history'); el.innerHTML = '';
    if(sales.length === 0){ el.innerHTML = '<div class="small">Nenhuma venda registrada.</div>'; return; }
    const sorted = [...sales].sort((a,b)=> new Date(b.ts) - new Date(a.ts));
    sorted.forEach(s => {
      const row = document.createElement('div'); row.style = 'background:white;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.03);';
      row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div><div style="font-weight:700">${new Date(s.ts).toLocaleString()}</div><div class="small">${s.items.map(i => `${i.name} x${i.qty}`).join(' ‚Ä¢ ')}</div></div>
        <div style="font-weight:800;color:var(--primary)">${formatMoney(s.total)}</div>
      </div>`;
      el.appendChild(row);
    });
  }

  function renderReports(){
    const totalRev = sales.reduce((a,b)=> a + Number(b.total||0), 0);
    const stockVal = products.reduce((a,b)=> a + (Number(b.price||0) * Number(b.stock||0)), 0);
    if(qs('#r-total')) qs('#r-total').textContent = formatMoney(totalRev);
    if(qs('#r-count')) qs('#r-count').textContent = sales.length;
    if(qs('#r-stock')) qs('#r-stock').textContent = formatMoney(stockVal);
  }

  // Cart operations
  function addToCart(id, qty=1){
    const p = products.find(x => String(x.id) === String(id));
    if(!p){ alert('Produto n√£o encontrado'); return; }
    qty = Number(qty) || 1;
    if(qty <= 0) return;

    if(Number(p.stock) < qty){
      showSalesAlert(`Estoque insuficiente para ${p.name}. Dispon√≠vel: ${p.stock}`);
      return;
    }

    const existing = cart.find(i => String(i.id) === String(p.id));
    if(existing){
      if(Number(p.stock) < existing.qty + qty){
        showSalesAlert(`Estoque insuficiente. Dispon√≠vel: ${p.stock}`);
        return;
      }
      existing.qty = Number(existing.qty) + Number(qty);
    } else {
      cart.push({ id: p.id, name: p.name, price: p.price, qty: Number(qty) });
    }

    // decrement stock immediately for cleaner UX
    p.stock = Number(p.stock) - Number(qty);

    // If low, show only short message (sidebar summary already updated)
    if(Number(p.stock) < 5) showSalesAlert(`Estoque baixo de ${p.name}: ${p.stock} un`);

    saveData(); renderCart(); renderProductsGridFull(); renderLowStockSummary(); renderLowStockFull(); renderReports();
  }

  function changeCartQty(id, delta){
    const item = cart.find(i => String(i.id) === String(id));
    if(!item) return;
    const p = products.find(x => String(x.id) === String(id));
    if(!p) return;
    if(delta > 0){
      if(Number(p.stock) < delta){ showSalesAlert(`Estoque insuficiente para ${p.name}`); return; }
      item.qty += delta; p.stock -= delta;
    } else {
      if(item.qty + delta <= 0){
        p.stock += item.qty;
        cart = cart.filter(i => String(i.id) !== String(id));
      } else {
        item.qty += delta; p.stock += (-delta);
      }
    }
    saveData(); renderCart(); renderProductsGridFull(); renderLowStockSummary(); renderLowStockFull(); renderReports();
  }

  function removeCartItem(id){
    const item = cart.find(i => String(i.id) === String(id));
    if(!item) return;
    const p = products.find(x => String(x.id) === String(id));
    if(p) p.stock = Number(p.stock) + Number(item.qty);
    cart = cart.filter(i => String(i.id) !== String(id));
    saveData(); renderCart(); renderProductsGridFull(); renderLowStockSummary(); renderLowStockFull(); renderReports();
  }

  function showSalesAlert(msg){
    const area = qs('#sales-alert-area');
    area.innerHTML = `<div class="alert-box">${msg}</div>`;
    setTimeout(()=> { if(area) area.innerHTML = ''; }, 3500);
  }

  // finalize sale
  function registerSale(){
    if(cart.length === 0){ showSalesAlert('Carrinho vazio'); return; }
    const total = cart.reduce((a,b)=> a + (Number(b.price) * Number(b.qty)), 0);
    const valorPago = parseFloat(qs('#valor-pago').value || 0);
    if(valorPago && valorPago < total){ showSalesAlert('Valor pago insuficiente'); return; }

    const sale = { id: uid(), items: cart.map(i=>({ ...i })), total, ts: new Date().toISOString() };
    sales.push(sale);

    const troco = valorPago ? (valorPago - total) : 0;
    if(qs('#troco')) qs('#troco').textContent = formatMoney(troco);

    cart = [];
    qs('#valor-pago').value = '';
    saveData(); refreshUI();

    const btn = qs('#btn-register-sale'); const orig = btn.innerHTML;
    btn.innerHTML = '<span class="material-icons-round">thumb_up</span> Venda salva';
    btn.style.background = 'var(--success)';
    setTimeout(()=>{ btn.innerHTML = orig; btn.style.background=''; }, 1400);
  }

  // modal add/edit product
  function openAddModal(editId=''){
    const bd = qs('#modal-backdrop'); bd.classList.add('active'); bd.setAttribute('aria-hidden','false'); bd.dataset.editId = editId || '';
    qs('#modal-title').textContent = editId ? 'Editar Produto' : 'Novo Produto';
    if(editId){
      const p = products.find(x=>String(x.id)===String(editId));
      qs('#p-name').value = p ? p.name : '';
      qs('#p-barcode').value = p ? (p.barcode||'') : '';
      qs('#p-price').value = p ? p.price : '';
      qs('#p-stock').value = p ? p.stock : '';
    } else {
      qs('#p-name').value=''; qs('#p-barcode').value=''; qs('#p-price').value=''; qs('#p-stock').value='';
    }
  }
  function closeModal(){ const bd=qs('#modal-backdrop'); bd.classList.remove('active'); bd.setAttribute('aria-hidden','true'); bd.dataset.editId=''; }

  function saveProduct(){
    const name = qs('#p-name').value.trim();
    const barcode = qs('#p-barcode').value.trim();
    const price = parseFloat(qs('#p-price').value);
    const stock = parseInt(qs('#p-stock').value||0);
    const editId = qs('#modal-backdrop').dataset.editId;
    if(!name || isNaN(price)){ alert('Preencha nome e pre√ßo'); return; }
    if(editId){
      const p = products.find(x=>String(x.id)===String(editId));
      if(p){ p.name=name; p.barcode=barcode; p.price=price; p.stock=stock; }
    } else {
      products.push({ id: uid(), name, barcode, price, stock });
    }
    saveData(); closeModal(); refreshUI();
  }

  // search by barcode / manual
  function handleBarcode(code){
    const p = products.find(x => x.barcode && String(x.barcode) === String(code));
    if(p){ addToCart(p.id, 1); showSalesAlert(`Produto encontrado e adicionado: ${p.name}`); return; }
    if(confirm(`C√≥digo "${code}" n√£o cadastrado. Deseja cadastrar agora?`)){
      openAddModal();
      setTimeout(()=> qs('#p-barcode').value = code, 80);
    }
  }

  // camera scanner
  function startScan(){
    const wrap = qs('#camera-area'); wrap.style.display='flex';
    video = qs('#video'); canvas = document.createElement('canvas');
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(s => { stream=s; video.srcObject = stream; video.setAttribute('playsinline',true); video.play(); scanning=true; tickScan(); })
      .catch(()=> { alert('N√£o foi poss√≠vel acessar a c√¢mera'); stopScan(); });
  }
  function stopScan(){ scanning=false; if(stream) stream.getTracks().forEach(t=>t.stop()); const wrap=qs('#camera-area'); if(wrap) wrap.style.display='none'; }
  function tickScan(){
    if(!scanning || !video) return;
    if(video.readyState === video.HAVE_ENOUGH_DATA){
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d'); ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const img = ctx.getImageData(0,0,canvas.width,canvas.height);
      if(window.jsQR){
        const code = jsQR(img.data, img.width, img.height, { inversionAttempts:'dontInvert' });
        if(code){ handleBarcode(code.data); stopScan(); return; }
      }
    }
    requestAnimationFrame(tickScan);
  }

  // backup / restore / reset
  function backupData(){
    const blob = new Blob([JSON.stringify({ products, sales, config }, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup_dry_lanches.json'; a.click();
  }
  function restoreDataFromFile(file){
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try{
        const data = JSON.parse(e.target.result);
        if(data.products && data.sales && data.config){
          if(confirm('Substituir dados atuais pelo backup?')){
            products = data.products; sales = data.sales; config = data.config;
            saveData(); refreshUI(); alert('Backup restaurado!');
          }
        } else alert('Arquivo inv√°lido');
      }catch{ alert('Erro ao ler arquivo'); }
    };
    reader.readAsText(file);
  }
  function resetData(){
    const pwd = prompt('Digite a senha de administrador:');
    if(pwd !== ADMIN_PASSWORD){ alert('Senha incorreta'); return; }
    localStorage.clear(); products=[]; sales=[]; config={store_name:'DRY LANCHES', currency:'R$'}; cart=[];
    saveData(); refreshUI(); alert('Sistema resetado');
  }

  // events binding
  function attachEvents(){
    // tabs
    qsa('.nav-btn').forEach(btn => btn.addEventListener('click', () => {
      qsa('.nav-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
      const tab = btn.dataset.tab;
      ['sales','products','history','settings'].forEach(t => qs('#tab-'+t).style.display = (t===tab ? 'block' : 'none'));
      window.scrollTo(0,0);
    }));

    // search updates select & product grid
    qs('#search-products').addEventListener('input', () => {
      renderProductSelect(); renderProductsGridFull();
    });

    // add to cart (from select)
    qs('#btn-add-to-cart').addEventListener('click', () => {
      const pid = qs('#sel-product').value; const qty = Number(qs('#qty').value || 1);
      if(!pid) { showSalesAlert('Selecione um produto'); return; }
      addToCart(pid, qty); renderCart();
    });

    // manual barcode
    qs('#btn-manual-code').addEventListener('click', () => {
      const code = prompt('Digite o c√≥digo de barras:'); if(code) handleBarcode(code.trim());
    });

    // camera toggle
    qs('#btn-toggle-camera').addEventListener('click', () => {
      const wrap = qs('#camera-area'); if(wrap.style.display === 'flex') stopScan(); else startScan();
    });
    qs('#btn-stop-scan').addEventListener('click', stopScan);

    // register sale
    qs('#btn-register-sale').addEventListener('click', registerSale);

    // calc change
    qs('#btn-calc-change').addEventListener('click', () => {
      const total = parseMoneyText(qs('#sale-total').textContent); const pago = parseFloat(qs('#valor-pago').value || 0);
      if(pago < total){ showSalesAlert('Valor pago insuficiente'); return; }
      qs('#troco').textContent = formatMoney(pago - total);
    });

    // modal controls
    qs('#btn-add-prod-tab').addEventListener('click', () => openAddModal());
    qs('#btn-close-modal').addEventListener('click', closeModal);
    qs('#btn-cancel-modal').addEventListener('click', closeModal);
    qs('#btn-save-product').addEventListener('click', saveProduct);

    // product grid actions (delegation)
    document.addEventListener('click', (e) => {
      const add = e.target.closest('[data-add]'); const edit = e.target.closest('[data-edit]');
      if(add){ addToCart(add.getAttribute('data-add'), 1); renderCart(); }
      if(edit){ openAddModal(edit.getAttribute('data-edit')); }
    });

    // backup / restore / reset
    qs('#btn-backup-data').addEventListener('click', backupData);
    qs('#btn-restore-data').addEventListener('click', () => qs('#import-file').click());
    qs('#import-file').addEventListener('change', e => restoreDataFromFile(e.target.files[0]));
    qs('#btn-reset-data').addEventListener('click', resetData);
    qs('#btn-open-restore').addEventListener('click', () => qs('#import-file').click());
    qs('#import-file-settings').addEventListener('change', e => restoreDataFromFile(e.target.files[0]));
  }

  // refresh UI
  function refreshUI(){
    renderProductSelect(); renderProductsGridFull(); renderCart(); renderHistory(); renderReports(); renderLowStockSummary(); renderLowStockFull();
  }

  // boot
  function boot(){
    loadData(); seedIfEmpty(); attachEvents(); refreshUI();
       // üîé ATIVAR BUSCA EM TEMPO REAL
const searchInput = qs('#search-products');
if (searchInput) {
  searchInput.addEventListener('input', () => {
    renderProductSelect();       // atualiza o select da √°rea de venda
    renderProductsGridFull();    // atualiza a √°rea de cat√°logo
  });
}

    // default tab show sales
    ['sales','products','history','settings'].forEach(t => qs('#tab-'+t).style.display = (t==='sales'?'block':'none'));
    // expose API
    window.DRY_App = { openAddModal };
  }

  boot();

})();
</script>
</body>
</html>
